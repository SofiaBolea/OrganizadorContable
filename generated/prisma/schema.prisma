// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =======================================
// NÚCLEO: ORGANIZACIÓN Y USUARIOS
// =======================================
model Organizacion {
  id                  String   @id @default(cuid())
  clerkOrganizationId String   @unique
  nombre              String   @db.VarChar(100)
  razonSocial         String?  @db.VarChar(150)
  cuit                String?  @db.VarChar(11)
  logoUrl             String?  @db.VarChar(255)
  emailContacto       String?  @db.VarChar(100)
  telefonoContacto    String?  @db.VarChar(50)
  direccion           String?  @db.VarChar(200)
  activa              Boolean  @default(true)
  fechaAlta           DateTime @default(now())

  // Relaciones
  usuarios           Usuario[]
  roles              Rol[]
  recursos           Recurso[]
  registrosAuditoria RegistroAuditoria[]

  @@map("organizaciones")
}

model Usuario {
  id                 String       @id @default(cuid())
  clerkId            String
  organizacionId     String
  organizacion       Organizacion @relation(fields: [organizacionId], references: [id])
  nombreUsuario      String       @db.VarChar(50)
  nombreCompleto     String       @db.VarChar(100)
  dni                String?      @db.VarChar(20)
  email              String       @db.VarChar(100)
  telefono           String?      @db.VarChar(50)
  permisoClientes    Boolean      @default(false)
  permisoVencimiento Boolean      @default(false)
  recursosRefPropios RecursoRef[] @relation("PropietarioReferencia")

  // Relaciones
  roles                UsuarioRol[]
  auditoriasEjecutadas RegistroAuditoria[] @relation("ejecutor")
  auditoriasAfectadas  RegistroAuditoria[] @relation("afectado")
  tareasAsignadas      TareaAsignacion[]   @relation("asignado")
  tareasAsignadasPor   TareaAsignacion[]   @relation("asignadoPor")
  vencimientosCreados  Vencimiento[]
  clientesAsignados    ClienteAsignacion[]
  refColores           RefColor[]

  @@unique([clerkId, organizacionId])
  @@index([organizacionId])
  @@map("usuarios")
}

// =======================================
// SEGURIDAD: RBAC, DSD Y AUDITORÍA
// =======================================
model Rol {
  id             String       @id @default(cuid())
  organizacionId String
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  nombreRol      String       @db.VarChar(50)
  descripcion    String?      @db.VarChar(200)

  // Relaciones
  usuariosRol UsuarioRol[]

  @@unique([organizacionId, nombreRol])
  @@map("roles")
}

model UsuarioRol {
  id        String    @id @default(cuid())
  usuarioId String
  usuario   Usuario   @relation(fields: [usuarioId], references: [id])
  rolId     String
  rol       Rol       @relation(fields: [rolId], references: [id])
  fechaAlta DateTime  @default(now()) @db.Date
  fechaBaja DateTime? @db.Date

  @@unique([usuarioId, rolId])
  @@index([usuarioId])
  @@index([rolId])
  @@map("usuarios_roles")
}

model RegistroAuditoria {
  id                String       @id @default(cuid())
  organizacionId    String
  organizacion      Organizacion @relation(fields: [organizacionId], references: [id])
  sesionId          String?
  ejecutadoPorId    String
  ejecutadoPor      Usuario      @relation("ejecutor", fields: [ejecutadoPorId], references: [id])
  usuarioAfectadoId String?
  usuarioAfectado   Usuario?     @relation("afectado", fields: [usuarioAfectadoId], references: [id])
  accion            String       @db.VarChar(50)
  fecha             DateTime     @default(now())
  detalleAccion     String?      @db.Text

  @@index([organizacionId])
  @@index([sesionId])
  @@index([ejecutadoPorId])
  @@map("registros_auditoria")
}

// =======================================
// RECURSOS (ESTRATEGIA TPT)
// =======================================
model Recurso {
  id             String       @id @default(cuid())
  organizacionId String
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id])
  nombre         String       @db.VarChar(100)
  descripcion    String?      @db.VarChar(255)
  tipoRecurso    String       @db.VarChar(50)

  // Herencia TPT
  cliente     Cliente?
  tarea       Tarea?
  vencimiento Vencimiento?
  refColor    RefColor?
  recursoRef  RecursoRef?

  @@index([organizacionId])
  @@index([tipoRecurso])
  @@map("recursos")
}

model RecursoRef {
  id        String  @id
  recurso   Recurso @relation(fields: [id], references: [id], onDelete: Cascade)
  titulo    String  @db.VarChar(100)
  url       String  @db.VarChar(255)
  tipo      String  @db.VarChar(50)
  usuarioId String
  usuario   Usuario @relation("PropietarioReferencia", fields: [usuarioId], references: [id])

  @@map("recursos_ref")
}

model RefColor {
  id         String  @id
  recurso    Recurso @relation(fields: [id], references: [id], onDelete: Cascade)
  usuarioId  String
  usuario    Usuario @relation(fields: [usuarioId], references: [id])
  titulo     String  @db.VarChar(50)
  codigoHexa String  @db.VarChar(7)

  // Relaciones
  tareasAsignadas TareaAsignacion[]

  @@index([usuarioId])
  @@map("ref_colores")
}

model Cliente {
  id             String  @id
  recurso        Recurso @relation(fields: [id], references: [id], onDelete: Cascade)
  nombreCompleto String  @db.VarChar(100)
  cuit           String? @db.VarChar(11)
  email          String? @db.VarChar(100)
  telefono       String? @db.VarChar(50)
  estado         String  @default("ACTIVO") @db.VarChar(20)

  asignaciones ClienteAsignacion[] // Relación con asistentes

  @@map("clientes")
}

model ClienteAsignacion {
  id        String   @id @default(cuid())
  clienteId String
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  usuarioId String
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  fecha     DateTime @default(now())

  @@unique([clienteId, usuarioId])
  @@map("clientes_asignaciones")
}

// =======================================
// MOTOR DE TAREAS (WORKFLOW ENGINE)
// =======================================
model Tarea {
  id                   String    @id
  recurso              Recurso   @relation(fields: [id], references: [id], onDelete: Cascade)
  titulo               String    @db.VarChar(100)
  prioridad            String    @default("MEDIA") @db.VarChar(20)
  fechaVencimientoBase DateTime?
  tipoTarea            String    @db.VarChar(20)

  // Relaciones
  recurrencia  Recurrencia?
  asignaciones TareaAsignacion[]

  @@map("tareas")
}

model Recurrencia {
  id         String @id @default(cuid())
  tareaId    String @unique
  tarea      Tarea  @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  frecuencia String @db.VarChar(20)
  intervalo  Int    @default(1)

  // Atributos RFC 5545
  diaSemana        String? @db.VarChar(50)
  diaDelMes        String? @db.VarChar(50)
  mesDelAnio       String? @db.VarChar(50)
  posicionConjunto Int?

  // Límites de la serie
  hastaFecha   DateTime?
  conteoMaximo Int?

  @@map("recurrencias")
}

model TareaAsignacion {
  id              String    @id @default(cuid())
  tareaId         String
  tarea           Tarea     @relation(fields: [tareaId], references: [id], onDelete: Cascade)
  refColorId      String?
  refColor        RefColor? @relation(fields: [refColorId], references: [id])
  asignadoId      String
  asignado        Usuario   @relation("asignado", fields: [asignadoId], references: [id])
  asignadoPorId   String
  asignadoPor     Usuario   @relation("asignadoPor", fields: [asignadoPorId], references: [id])
  fechaAsignacion DateTime  @default(now())
  estado          String    @default("ACTIVA") @db.VarChar(20)

  // Relaciones
  ocurrencias Ocurrencia[]

  @@index([tareaId])
  @@index([asignadoId])
  @@map("tareas_asignaciones")
}

model Ocurrencia {
  id                String          @id @default(cuid())
  tareaAsignacionId String
  tareaAsignacion   TareaAsignacion @relation(fields: [tareaAsignacionId], references: [id], onDelete: Cascade)
  fechaOriginal     DateTime        @db.Date
  fechaEjecucion    DateTime?
  fechaOverride     DateTime?       @db.Date
  tituloOverride    String?         @db.VarChar(100)
  estado            String          @default("PENDIENTE") @db.VarChar(20)
  colorOverride     String?         @db.VarChar(7)

  @@index([tareaAsignacionId])
  @@index([fechaOriginal])
  @@map("ocurrencias")
}

// =======================================
// GESTIÓN DE VENCIMIENTOS
// =======================================
model Vencimiento {
  id               String  @id
  recurso          Recurso @relation(fields: [id], references: [id], onDelete: Cascade)
  usuarioCreadorId String
  usuarioCreador   Usuario @relation(fields: [usuarioCreadorId], references: [id])
  tipoVencimiento  String  @db.VarChar(20)
  jurisdiccion     String? @db.VarChar(50)
  titulo           String  @db.VarChar(100)
  periodicidad     String  @db.VarChar(20)
  estado           String  @default("ACTIVO") @db.VarChar(20)

  // Relaciones
  ocurrencias VencimientoOcurrencia[]

  @@index([usuarioCreadorId])
  @@map("vencimientos")
}

model VencimientoOcurrencia {
  id               String      @id @default(cuid())
  vencimientoId    String
  vencimiento      Vencimiento @relation(fields: [vencimientoId], references: [id], onDelete: Cascade)
  fechaVencimiento DateTime    @db.Date
  estado           String      @default("ACTIVA") @db.VarChar(20)

  @@index([vencimientoId])
  @@index([fechaVencimiento])
  @@map("vencimientos_ocurrencias")
}
